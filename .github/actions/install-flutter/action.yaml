name: Install Flutter
description: Install pinned Flutter SDK on runner

outputs:
  download-url:
    description: Flutter SDK archive download URL
    value: ${{ steps.meta.outputs.download-url }}
  flutter-root:
    description: Installed Flutter SDK root directory
    value: ${{ steps.meta.outputs.flutter-root }}

runs:
  using: composite
  steps:
    - name: Compute download URL
      id: meta
      shell: bash
      run: |
        set -euo pipefail

        FLUTTER_VERSION="3.41.1"
        BASE_URL="https://storage.googleapis.com/flutter_infra_release/releases/stable"

        # Support: Windows/Linux x64, macOS arm64
        case "${RUNNER_OS}" in
          Windows) platform="windows"; arch="x64" ;;
          Linux)   platform="linux";   arch="x64" ;;
          macOS)   platform="macos";   arch="arm64" ;;
          *)
            echo "Unsupported RUNNER_OS: ${RUNNER_OS}" >&2
            exit 1
            ;;
        esac

        case "${platform}" in
          windows) file="flutter_windows_${FLUTTER_VERSION}-stable.zip" ;;
          macos)   file="flutter_macos_${arch}_${FLUTTER_VERSION}-stable.zip" ;;
          linux)   file="flutter_linux_${FLUTTER_VERSION}-stable.tar.xz" ;;
        esac

        url="${BASE_URL}/${platform}/${file}"

        # For env/path files, Windows prefers Windows-style paths.
        if [[ "${platform}" == "windows" ]] && command -v cygpath >/dev/null 2>&1; then
          flutter_root_out="$(cygpath -w "${RUNNER_TEMP}")\\flutter"
        else
          flutter_root_out="${RUNNER_TEMP}/flutter"
        fi

        echo "download-url=${url}" >> "${GITHUB_OUTPUT}"
        echo "flutter-root=${flutter_root_out}" >> "${GITHUB_OUTPUT}"

    - name: Download and extract Flutter
      shell: bash
      run: |
        set -euo pipefail

        url='${{ steps.meta.outputs.download-url }}'

        # In bash on Windows, convert RUNNER_TEMP to a unix path for tools like unzip/rm/mv.
        runner_temp="${RUNNER_TEMP}"
        if [[ "${RUNNER_OS}" == "Windows" ]] && command -v cygpath >/dev/null 2>&1; then
          runner_temp="$(cygpath -u "${RUNNER_TEMP}")"
        fi

        archive_name="${url##*/}"
        archive_local="${runner_temp}/${archive_name}"
        flutter_root="${runner_temp}/flutter"

        curl -fL --connect-timeout 15 --retry 5 "${url}" > "${archive_local}"

        if [[ "${archive_name}" == *.zip ]]; then
          EXTRACT_PATH="${runner_temp}/_unzip_temp"
          rm -rf "${EXTRACT_PATH}"
          mkdir -p "${EXTRACT_PATH}"

          if ! command -v unzip >/dev/null 2>&1; then
            echo "unzip not found (required to extract ${archive_name})." >&2
            exit 1
          fi

          unzip -q -o "${archive_local}" -d "${EXTRACT_PATH}"

          rm -rf "${flutter_root}"
          mv "${EXTRACT_PATH}/flutter" "${flutter_root}"
          rm -rf "${EXTRACT_PATH}"
        else
          rm -rf "${flutter_root}"
          mkdir -p "${flutter_root}"
          tar xf "${archive_local}" -C "${flutter_root}" --strip-components=1
        fi

        rm -f "${archive_local}"

        # Export env vars + PATH for subsequent workflow steps.
        if [[ "${RUNNER_OS}" == "Windows" ]] && command -v cygpath >/dev/null 2>&1; then
          flutter_root_env="$(cygpath -w "${flutter_root}")"
          echo "FLUTTER_ROOT=${flutter_root_env}" >> "${GITHUB_ENV}"
          printf '%s\n' "${flutter_root_env}\\bin" >> "${GITHUB_PATH}"
          printf '%s\n' "${flutter_root_env}\\bin\\cache\\dart-sdk\\bin" >> "${GITHUB_PATH}"
        else
          echo "FLUTTER_ROOT=${flutter_root}" >> "${GITHUB_ENV}"
          echo "${flutter_root}/bin" >> "${GITHUB_PATH}"
          echo "${flutter_root}/bin/cache/dart-sdk/bin" >> "${GITHUB_PATH}"
        fi

        # Smoke test inside this step.
        if [[ "${RUNNER_OS}" == "Windows" ]]; then
          "${flutter_root}/bin/flutter.bat" --version
        else
          export PATH="${flutter_root}/bin:${flutter_root}/bin/cache/dart-sdk/bin:${PATH}"
          flutter --version
        fi
