name: Release

on:
  push:
    branches: [main]

permissions:
  contents: write

concurrency:
  group: release-main
  cancel-in-progress: false

env:
  # Single pinned Flutter version reused across all platforms.
  # Manual install docs: https://docs.flutter.dev/install/manual
  FLUTTER_VERSION: "3.35.4"

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      release: ${{ steps.check.outputs.release }}
      version: ${{ steps.check.outputs.version }}
      build_number: ${{ github.run_number }}
    steps:
      - name: Checkout
        # https://github.com/actions/checkout/releases/tag/v6.0.2
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: Setup Node.js
        # https://github.com/actions/setup-node/releases/tag/v6.2.0
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: "lts/*"

      - name: Install semantic-release
        run: |
          npm install --no-save \
            semantic-release \
            conventional-changelog-conventionalcommits
            
      - name: Run semantic-release (dry-run)
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          OUTPUT="$(npx semantic-release --dry-run)"
          echo "${OUTPUT}"
          VERSION="$(echo "$OUTPUT" | grep -im1 "The next release version is" | awk '{print $NF}' || true)"
          if [ -n "${VERSION}" ]; then
            echo "Next release: true"
            echo "Next version: ${VERSION}"
            echo "release=true" >> "$GITHUB_OUTPUT"
            echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          else
            echo "Next release: false"
            echo "release=false" >> "$GITHUB_OUTPUT"
          fi

  build:
    needs: plan
    if: needs.plan.outputs.release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: macos
          - os: windows-latest
            platform: windows
          - os: ubuntu-latest
            platform: linux
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        # https://github.com/actions/checkout/releases/tag/v6.0.2
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      - name: Setup Flutter (macOS)
        if: matrix.platform == 'macos'
        run: |
          set -euo pipefail

          echo "Installing Flutter ${FLUTTER_VERSION} (stable) manually for macOS."
          echo "Info: This workflow intentionally avoids setup-flutter GitHub Actions."

          cd "${RUNNER_TEMP}"

          ARCH="$(uname -m)"
          case "${ARCH}" in
            arm64) FLUTTER_ARCH="arm64" ;;
            x86_64) FLUTTER_ARCH="x64" ;;
            *)
              echo "Unsupported macOS runner architecture: ${ARCH}"
              exit 1
              ;;
          esac

          # Persist arch for later steps (e.g., artifact naming).
          echo "FLUTTER_ARCH=${FLUTTER_ARCH}" >> "${GITHUB_ENV}"

          FLUTTER_ZIP="flutter_macos_${FLUTTER_ARCH}_${FLUTTER_VERSION}-stable.zip"
          FLUTTER_URL="https://storage.googleapis.com/flutter_infra_release/releases/stable/${FLUTTER_VERSION}/${FLUTTER_ZIP}"

          echo "Downloading ${FLUTTER_URL}"
          curl -fL "${FLUTTER_URL}" -o flutter.zip

          rm -rf flutter 2>/dev/null
          unzip -q flutter.zip

          echo "${RUNNER_TEMP}/flutter/bin" >> "${GITHUB_PATH}"
          flutter --version

      - name: Setup Flutter (Windows)
        if: matrix.platform == 'windows'
        run: |
          Write-Host "Flutter setup placeholder for Windows (pinned version: ${{ env.FLUTTER_VERSION }})."
          Write-Host "Info: This workflow intentionally avoids setup-flutter GitHub Actions."

      - name: Setup Flutter (Linux)
        if: matrix.platform == 'linux'
        run: |
          echo "Flutter setup placeholder for Linux (pinned version: ${FLUTTER_VERSION})."
          echo "Info: This workflow intentionally avoids setup-flutter GitHub Actions."

      - name: Install dependencies
        if: matrix.platform == 'macos'
        run: flutter pub get

      - name: Build Windows
        if: matrix.platform == 'windows'
        run: |
          Write-Host "Windows build placeholder (no real build yet)."
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Set-Content -Path "dist/windows-${{ needs.plan.outputs.version }}+${{ needs.plan.outputs.build_number }}.zip" -Value "windows build placeholder"

      - name: Build macOS (zip .app)
        if: matrix.platform == 'macos'
        run: |
          set -euo pipefail

          flutter build macos --release \
            --build-name="${{ needs.plan.outputs.version }}" \
            --build-number="${{ needs.plan.outputs.build_number }}"

          mkdir -p dist
          APP_PATH="$(find build/macos/Build/Products/Release -maxdepth 1 -name '*.app' -print -quit)"
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" \
            "dist/macos-${FLUTTER_ARCH}-${{ needs.plan.outputs.version }}+${{ needs.plan.outputs.build_number }}.zip"

      - name: Build Linux
        if: matrix.platform == 'linux'
        run: |
          echo "Linux build placeholder (no real build yet)."
          mkdir -p dist
          echo "linux build placeholder" > "dist/linux-${{ needs.plan.outputs.version }}+${{ needs.plan.outputs.build_number }}.tar.gz"

      - name: Upload build artifacts
        # https://github.com/actions/upload-artifact/releases/tag/v6.0.0
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: dist-${{ matrix.platform }}
          path: dist/**
          if-no-files-found: warn

  release:
    needs: [plan, build]
    if: needs.plan.outputs.release == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        # https://github.com/actions/checkout/releases/tag/v6.0.2
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Download build artifacts
        # https://github.com/actions/download-artifact/releases/tag/v7.0.0
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          path: dist

      - name: Collect release assets
        run: |
          set -euo pipefail
          mkdir -p release_assets
          find dist -type f -maxdepth 2 -print -exec cp -v {} release_assets/ \;

      - name: Setup Node.js
        # https://github.com/actions/setup-node/releases/tag/v6.2.0
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: "lts/*"

      - name: Install semantic-release
        run: |
          npm install --no-save \
            semantic-release \
            conventional-changelog-conventionalcommits

      - name: Run semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUILD_NUMBER: ${{ needs.plan.outputs.build_number }}
        run: npx semantic-release --debug
