name: Release

on:
  push:
    branches: [ main ]

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  commitlint:
    runs-on: ubuntu-latest
    steps:
      # https://github.com/actions/checkout/releases/tag/v6.0.2
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          fetch-depth: 0

      # https://github.com/actions/setup-node/releases/tag/v6.2.0
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238
        with:
          node-version: "lts/*"

      - name: Install commitlint
        run: |
          npm install -D \
            @commitlint/cli \
            @commitlint/config-conventional

      - name: Validate PR commits
        if: github.event_name == 'pull_request'
        run: npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose

      - name: Validate commints since the most recent commit before the push
        if: github.event_name == 'push'
        run: npx commitlint --from ${{ github.event.before }} --to ${{ github.sha }} --verbose

  plan:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    outputs:
      release: ${{ steps.check.outputs.release }}
      version: ${{ steps.check.outputs.version }}
      build_number: ${{ github.run_number }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Install semantic-release (for dry-run only)
        run: |
          npm install -D \
            semantic-release \
            conventional-changelog-conventionalcommits
            
      - name: Check for release (dry-run)
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          OUTPUT="$(npx semantic-release --dry-run)"
          echo "${OUTPUT}"
          VERSION="$(echo "$OUTPUT" | grep -m1 "The next release version is" | awk '{print $NF}' || true)"
          if [ -n "${VERSION}" ]; then
            echo "release=true" >> "$GITHUB_OUTPUT"
            echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          else
            echo "release=false" >> "$GITHUB_OUTPUT"
          fi

  build:
    needs: plan
    if: needs.plan.outputs.release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: android
          - os: macos-latest
            platform: macos
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.x"
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build Android APK
        if: matrix.platform == 'android'
        run: |
          # flutter build apk --release \
          #   --build-name="${{ needs.plan.outputs.version }}" \
          #   --build-number="${{ needs.plan.outputs.build_number }}"

          mkdir -p dist
          echo "androd apk test" > "dist/app-${{ needs.plan.outputs.version }}+${{ needs.plan.outputs.build_number }}.apk"
          # cp build/app/outputs/flutter-apk/app-release.apk \
          #   "dist/app-${{ needs.plan.outputs.version }}+${{ needs.plan.outputs.build_number }}.apk"

      - name: Build macOS (zip .app)
        if: matrix.platform == 'macos'
        run: |
          # flutter build macos --release \
          #   --build-name="${{ needs.plan.outputs.version }}" \
          #   --build-number="${{ needs.plan.outputs.build_number }}"

          mkdir -p dist
          echo "macos zip test" > "dist/macos-${{ needs.plan.outputs.version }}+${{ needs.plan.outputs.build_number }}.zip"
          # APP_PATH="$(find build/macos/Build/Products/Release -maxdepth 1 -name '*.app' -print -quit)"
          # ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" \
          #   "dist/macos-${{ needs.plan.outputs.version }}+${{ needs.plan.outputs.build_number }}.zip"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.platform }}
          path: dist/*

  release:
    needs: [plan, build]
    if: needs.plan.outputs.release == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Collect release assets
        run: |
          set -euo pipefail
          mkdir -p release_assets
          find dist -type f -maxdepth 2 -print -exec cp -v {} release_assets/ \;

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "lts/*"

      - name: Install release tooling
        run: |
          npm install -D \
            semantic-release \
            conventional-changelog-conventionalcommits

      - name: Run semantic-release (publish)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUILD_NUMBER: ${{ needs.plan.outputs.build_number }}
        run: npx semantic-release --debug
